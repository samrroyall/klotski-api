name: ci-cd

on:
  push:
    branches:
      - main

jobs:
  deploy:
    name: Deploy app
    runs-on: ubuntu-latest
    concurrency: deploy-group
    steps:
      - uses: actions/checkout@v4
      - uses: superfly/flyctl-actions/setup-flyctl@master
      - run: flyctl deploy --remote-only --config ./compose.yaml
        env:
          ENVIRONMENT: $${{ vars.ENVIRONMENT }}
          LOG_LEVEL: ${{ vars.LOG_LEVEL }}
          BIND_URL: ${{ vars.BIND_URL }}
          BIND_PORT: ${{ vars.BIND_PORT }}
          ALLOWED_ORIGINS: ${{ vars.ALLOWED_ORIGINS }}
          PG_PORT: ${{ vars.PG_PORT }}
          PG_DATABASE: ${{ secrets.PG_DATABASE }}
          PG_USERNAME: ${{ secrets.PG_USERNAME }}
          PG_PASSWORD: ${{ secrets.PG_PASSWORD }}
          SENTRY_DSN: ${{ secrets.SENTRY_DSN }}
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}
